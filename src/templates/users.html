{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1">User Management</h3>
        <div class="section-subtitle">Last updated {{ last_updated }}</div>
    </div>
    <a class="btn btn-dark btn-sm" href="{{ request.url_for('users_health') }}">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
    </a>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="text-muted text-uppercase" style="font-size: 0.85rem;">Total Users</h5>
                <h3 class="mb-0 fw-bold">{{ metrics.total }}</h3>
                <small class="text-muted">All active accounts</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="text-muted text-uppercase" style="font-size: 0.85rem;">Active</h5>
                <h3 class="mb-0 fw-bold text-success">{{ metrics.active }}</h3>
                <small class="text-muted">Enabled accounts</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="text-muted text-uppercase" style="font-size: 0.85rem;">Locked</h5>
                <h3 class="mb-0 fw-bold text-warning">{{ metrics.locked }}</h3>
                <small class="text-muted">Restricted access</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="text-muted text-uppercase" style="font-size: 0.85rem;">Verified Emails</h5>
                <h3 class="mb-0 fw-bold">{{ metrics.verified }}</h3>
                <small class="text-muted">Email verified</small>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Authentication Provider Distribution</span>
        <span class="section-subtitle">Top providers by usage</span>
    </div>
    <div class="card-body">
        <canvas id="providerChart"></canvas>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Recent Users</span>
        <span class="section-subtitle">Most recent logins</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>User ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Verified</th>
                    <th>Last Login</th>
                </tr>
            </thead>
            <tbody>
                {% for row in users %}
                <tr>
                    <td><small class="text-muted">{{ row.id }}</small></td>
                    <td>{{ row.name }}</td>
                    <td>{{ row.email }}</td>
                    <td><small>{{ row.phone }}</small></td>
                    <td><span class="badge bg-secondary">{{ row.provider }}</span></td>
                    <td>{{ row.status }}</td>
                    <td>{{ row.verified }}</td>
                    <td><small>{{ row.last_login }}</small></td>
                </tr>
                {% endfor %}
                {% if users|length == 0 %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">No user records found.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    const providerLabels = {{ provider_labels | tojson }};
    const providerCounts = {{ provider_counts | tojson }};

    const ctx = document.getElementById('providerChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: providerLabels,
                datasets: [{
                    data: providerCounts,
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#6c757d'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
</script>
{% endblock %}